<%- include('partials/header') %>

<h2>Generate JSON-LD Schemas for WordPress + RankMath</h2>

<div class="card">
  <h3>1. Connect to Your Site</h3>
  <p style="color: #666; margin-bottom: 1rem;">
    Enter your RankMath Helper Plugin connection details.
  </p>

  <form id="rankmath-credentials-form">
    <div class="form-row">
      <div class="form-group" style="flex: 2;">
        <label for="rmSiteUrl">Site URL</label>
        <input type="url" id="rmSiteUrl" name="rmSiteUrl" placeholder="https://example.com" required>
      </div>
      <div class="form-group" style="flex: 1;">
        <label for="rmSecretToken">Secret Token</label>
        <input type="password" id="rmSecretToken" name="rmSecretToken" placeholder="your-token">
      </div>
    </div>
    <button type="button" id="test-rankmath-connection" class="btn btn-secondary">Connect</button>
    <span id="rankmath-connection-status"></span>
  </form>
</div>

<div class="card">
  <h3>Organization Info (for Schema)</h3>
  <div class="info-box" style="background: #fff3e0; border-color: #ffb74d; color: #e65100;">
    <strong>Important:</strong> Fill in Organization Name and Areas Served to avoid Google Rich Results errors.
    Use "Auto-Detect from Site" to auto-fill these fields from your website.
  </div>
  <div class="auto-detect-section">
    <div class="form-group" style="flex: 1;">
      <label for="detectUrl">Website URL (to auto-detect info)</label>
      <input type="url" id="detectUrl" placeholder="https://example.com">
    </div>
    <button type="button" id="detect-org-info" class="btn btn-secondary">Auto-Detect from Site</button>
    <span id="detect-status"></span>
    <small style="color: #777; display: block; margin-top: 4px;">Configure an AI provider below for best results. Without AI, basic scraping is used as fallback.</small>
  </div>
  <form id="org-form">
    <div class="form-group">
      <label for="orgName">Organization Name</label>
      <input type="text" id="orgName" name="orgName" value="<%= defaultOrg.name %>" placeholder="Your Company Name">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="orgUrl">Organization URL</label>
        <input type="url" id="orgUrl" name="orgUrl" value="<%= defaultOrg.url %>" placeholder="https://example.com">
      </div>
      <div class="form-group">
        <label for="orgLogo">Logo URL</label>
        <input type="url" id="orgLogo" name="orgLogo" value="<%= defaultOrg.logo %>" placeholder="https://example.com/logo.png">
      </div>
    </div>
    <div class="form-group">
      <label for="ogImage">Schema Image URL (optional)</label>
      <input type="url" id="ogImage" name="ogImage" placeholder="https://example.com/image.jpg (overrides auto-detected image)">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="areaServed">Areas Served (one per line or comma-separated)</label>
        <textarea id="areaServed" name="areaServed" rows="4" placeholder="Hamilton
Burlington
Oakville
St Catharines
Grimsby"></textarea>
      </div>
      <div class="form-group">
        <label for="businessType">Business Type</label>
        <select id="businessType" name="businessType">
          <option value="HVACBusiness">HVAC Business</option>
          <option value="Plumber">Plumbing Business</option>
          <option value="Electrician">Electrical Business</option>
          <option value="RoofingContractor">Roofing Contractor</option>
          <option value="GeneralContractor">General Contractor</option>
          <option value="HomeAndConstructionBusiness">Home Services (General)</option>
          <option value="LocalBusiness">Local Business (Generic)</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label for="phone">Business Phone</label>
      <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="streetAddress">Street Address (optional)</label>
        <input type="text" id="streetAddress" name="streetAddress" placeholder="123 Main St">
      </div>
      <div class="form-group">
        <label for="addressLocality">City</label>
        <input type="text" id="addressLocality" name="addressLocality" placeholder="Houston">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="addressRegion">State</label>
        <input type="text" id="addressRegion" name="addressRegion" placeholder="TX">
      </div>
      <div class="form-group">
        <label for="postalCode">ZIP Code (optional)</label>
        <input type="text" id="postalCode" name="postalCode" placeholder="77001">
      </div>
    </div>
    <p class="help-text">Address is recommended for Google Rich Results. If not provided, city will be derived from Areas Served.</p>
    <div class="form-group">
      <label for="sameAs">Social Profiles / sameAs URLs (one per line)</label>
      <textarea id="sameAs" name="sameAs" rows="4" placeholder="https://www.facebook.com/yourbusiness
https://www.linkedin.com/company/yourbusiness
https://www.yelp.com/biz/yourbusiness
https://www.instagram.com/yourbusiness"></textarea>
    </div>
  </form>
</div>

<div class="card">
  <h3>AI Verification (Optional)</h3>
  <div class="ai-settings">
    <div class="form-row">
      <div class="form-group">
        <label for="aiProvider">AI Provider</label>
        <select id="aiProvider" name="aiProvider">
          <option value="">-- Select Provider --</option>
          <option value="openai">OpenAI (GPT-4)</option>
          <option value="gemini">Google Gemini</option>
        </select>
      </div>
      <div class="form-group">
        <label for="aiModel">Model</label>
        <select id="aiModel" name="aiModel">
          <option value="">-- Select model after provider --</option>
        </select>
      </div>
    </div>
    <div class="form-row" id="api-key-inputs">
      <div class="form-group" id="openai-key-group" style="display:none;">
        <label for="openaiApiKey">OpenAI API Key</label>
        <input type="password" id="openaiApiKey" name="openaiApiKey" placeholder="sk-...">
      </div>
      <div class="form-group" id="gemini-key-group" style="display:none;">
        <label for="geminiApiKey">Gemini API Key</label>
        <input type="password" id="geminiApiKey" name="geminiApiKey" placeholder="AIza...">
      </div>
    </div>
    <div id="ai-status" class="ai-status"></div>
    <p class="help-text">AI can verify: page type detection, business info, locations, reviews, and FAQs. Enter your API key above or configure in .env file.</p>

    <details class="ai-prompts-details">
      <summary>View AI Prompts Used</summary>
      <div class="ai-prompts-content">
        <h5>Main Verification Prompt</h5>
        <p>This prompt analyzes the page content and extracts/verifies:</p>
        <pre class="prompt-preview">Analyze this web page content and verify/enhance the extracted data.

## Page Information
URL: [page url]
Title: [page title]
Description: [meta description]

## Page Content (first 3000 chars)
[page content...]

## Currently Extracted Data
Page Type: [service|location|article]
Business Name: [org name]
Phone: [detected phone]
Location: [city if location page]

## Extracted FAQs
[list of Q&A pairs found]

## Your Task
Analyze the page and respond with JSON containing:
- pageType (detected, confidence, reason)
- businessInfo (name correct, phone found, address)
- location (city, state, service areas)
- reviews (customer testimonials found)
- faqs (verified, missing, suggested)
- serviceType (primary, category, all services)</pre>

        <h5>Review Extraction Prompt</h5>
        <p>Finds customer reviews and testimonials:</p>
        <pre class="prompt-preview">Find customer reviews and testimonials on this page.
Look for:
- Direct customer quotes
- Star ratings
- Review snippets
- Testimonial sections

Returns: reviews array with text, author, rating, source</pre>

        <h5>FAQ Verification Prompt</h5>
        <p>Verifies extracted FAQs and finds missed ones:</p>
        <pre class="prompt-preview">Verify the extracted FAQs and find any that were missed.
Tasks:
1. Verify extracted FAQs are accurate
2. Find any FAQs on the page that weren't extracted
3. Do NOT make up FAQs - only include what's on the page

Returns: verified FAQs, missed FAQs, total count</pre>
      </div>
    </details>
  </div>
</div>

<div class="card">
  <h3>2. Generate Schemas</h3>

  <div class="tabs">
    <button class="tab active" data-tab="single">Single URL</button>
    <button class="tab" data-tab="paste">URL List</button>
  </div>

  <div class="tab-content active" id="single-tab">
    <form id="single-form">
      <div class="form-group">
        <label for="singleUrl">Page URL</label>
        <input type="url" id="singleUrl" name="singleUrl" placeholder="https://example.com/my-page">
      </div>
      <button type="submit" class="btn btn-primary">Generate Schema</button>
    </form>
  </div>

  <div class="tab-content" id="paste-tab">
    <form id="paste-form">
      <div class="form-group">
        <label for="pasteUrls">Paste URLs (one per line)</label>
        <textarea id="pasteUrls" name="pasteUrls" rows="6" placeholder="https://example.com/ac-repair
https://example.com/heating
https://example.com/about"></textarea>
      </div>
      <div class="paste-info">
        <span id="paste-url-count">0</span> URLs
      </div>
      <button type="submit" class="btn btn-primary">Generate Schemas</button>
    </form>
  </div>

</div>

<div id="results" class="card hidden">
  <h3>Generated Schemas (Dry Run Preview)</h3>
  <div class="info-box">
    <strong>Preview Mode:</strong> These schemas have been generated but NOT published yet.
    Review them below, then select which ones to insert into WordPress via RankMath.
  </div>
  <div id="progress" class="progress hidden">
    <div class="progress-bar" id="progress-bar"></div>
    <span id="progress-text">Processing...</span>
  </div>

  <div id="filter-controls" class="filter-controls hidden">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All <span id="count-all">0</span></button>
      <button class="filter-tab" data-filter="service">Services <span id="count-service">0</span></button>
      <button class="filter-tab" data-filter="location">Locations <span id="count-location">0</span></button>
      <button class="filter-tab" data-filter="article">Blog Posts <span id="count-article">0</span></button>
    </div>
    <div class="filter-stats">
      <span class="filter-stat"><span id="count-preview">0</span> pending</span>
      <span class="filter-stat success"><span id="count-inserted">0</span> inserted</span>
    </div>
  </div>

  <div id="schemas-container"></div>
  <div id="insert-controls" class="hidden">
    <div class="insert-options">
      <label class="checkbox-label">
        <input type="checkbox" id="select-all-schemas" checked>
        Select/Deselect All Visible
      </label>
    </div>
    <div class="button-group">
      <button id="insert-selected" class="btn btn-primary">Insert Selected to WordPress</button>
      <button id="save-as-json" class="btn btn-secondary">Save as JSON</button>
      <button id="copy-all-schemas" class="btn btn-secondary">Copy to Clipboard</button>
      <button id="download-all-schemas" class="btn btn-secondary">Download All</button>
    </div>
    <p class="help-text">Insert directly to RankMath, save schemas as JSON file, or download all as ZIP.</p>
    <div class="ai-verify-section">
      <h4>AI Verification & Google Compliance</h4>
      <p class="help-text">Verify schemas are accurate and will pass Google Rich Results Test.</p>
      <div class="button-group">
        <button id="google-compliance-check" class="btn btn-primary" onclick="verifyAllGoogleCompliance()">Check Google Compliance</button>
        <button id="ai-verify-selected" class="btn btn-secondary">Verify Selected with AI</button>
        <button id="ai-verify-all" class="btn btn-secondary">Verify All with AI</button>
      </div>
      <div id="ai-verify-progress" class="hidden">
        <span id="ai-verify-status">Verifying...</span>
      </div>
      <div class="compliance-legend">
        <span class="compliance-badge passed">✓ Google Ready</span> = Will pass Rich Results Test
        <span class="compliance-badge warnings">⚠ Valid</span> = Has recommendations
        <span class="compliance-badge failed">✗ Needs Fixes</span> = Fix before publishing
      </div>
    </div>

    <div class="bulk-publish-section">
      <h4>Bulk Publish by Type</h4>
      <div class="button-group">
        <button id="insert-all-services" class="btn btn-success">Publish All Services (<span id="btn-count-service">0</span>)</button>
        <button id="insert-all-locations" class="btn btn-success">Publish All Locations (<span id="btn-count-location">0</span>)</button>
        <button id="insert-all-articles" class="btn btn-success">Publish All Blog Posts (<span id="btn-count-article">0</span>)</button>
      </div>
    </div>
    <div class="rankmath-info">
      <details>
        <summary>How does RankMath insertion work?</summary>
        <p>Schemas are inserted via the WordPress REST API into RankMath's post meta fields:</p>
        <ul>
          <li><code>rank_math_schema_Article</code> - for blog posts</li>
          <li><code>rank_math_schema_Service</code> - for service pages</li>
        </ul>
        <p>The schema will appear in RankMath's Schema tab when editing the post/page in WordPress admin.</p>
        <p><strong>Requirements:</strong> RankMath Pro (or free with REST API enabled), WordPress Application Password.</p>
      </details>
    </div>
  </div>
</div>

<div id="schema-preview" class="modal hidden">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h3>Schema Preview (Dry Run)</h3>
    <div class="preview-meta">
      <span class="preview-url" id="preview-url"></span>
      <span class="preview-type" id="preview-type"></span>
      <span id="preview-validation"></span>
    </div>
    <div class="preview-meta" id="preview-schema-types"></div>
    <div id="preview-compliance" class="preview-compliance"></div>
    <pre id="schema-json"></pre>
    <div class="modal-actions">
      <button id="copy-schema" class="btn btn-secondary">Copy Schema JSON</button>
      <button id="insert-single" class="btn btn-primary">Publish to WordPress via RankMath</button>
    </div>
    <div class="modal-note">
      <p><strong>To manually import into RankMath:</strong></p>
      <ol>
        <li>Click "Copy Schema JSON" above</li>
        <li>In WordPress, edit the page → RankMath → Schema → Add Schema</li>
        <li>Choose "Custom Schema" or click "Code Validation" tab</li>
        <li>Paste the JSON and save</li>
      </ol>
    </div>
  </div>
</div>

<div id="schema-diff-modal" class="modal hidden">
  <div class="modal-content modal-wide">
    <span class="modal-close" onclick="document.getElementById('schema-diff-modal').classList.add('hidden')">&times;</span>
    <h3>Schema Diff</h3>
    <div class="diff-meta">
      <span class="diff-url" id="diff-url"></span>
    </div>
    <div id="diff-summary" class="diff-summary"></div>
    <div id="diff-content" class="diff-content"></div>
  </div>
</div>

<div class="card">
  <h3>Activity Log</h3>
  <div class="log-stats" id="log-stats">
    <span class="stat-item">Today: <strong id="stat-today">0</strong></span>
    <span class="stat-item">Tokens: <strong id="stat-tokens">0</strong></span>
  </div>
  <div class="log-controls">
    <button type="button" id="refresh-logs" class="btn btn-secondary btn-small">Refresh</button>
    <button type="button" id="clear-logs" class="btn btn-danger btn-small">Clear Logs</button>
    <select id="log-filter">
      <option value="">All Actions</option>
      <option value="schema_generated">Generated</option>
      <option value="schema_inserted">Inserted</option>
      <option value="ai_verification">AI Verified</option>
      <option value="error">Errors</option>
    </select>
  </div>
  <div id="activity-log" class="activity-log">
    <p class="log-empty">No activity yet</p>
  </div>
</div>

    </div>
  </main>
  <footer class="footer">
    <div class="container">
      <p>WordPress Schema Generator - Generate JSON-LD for RankMath</p>
    </div>
  </footer>

  <!-- Back to Top Button -->
  <button class="back-to-top" id="back-to-top" title="Back to top">↑</button>

  <script src="/js/app.js"></script>
</body>
</html>
